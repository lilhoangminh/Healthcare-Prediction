import streamlit as st
import pandas as pd
import numpy as np
import tensorflow as tf
from tensorflow import keras
import os
import re

st.set_page_config(
    page_title="D·ª± ƒëo√°n b·ªánh t·ª´ tri·ªáu ch·ª©ng",
    page_icon="üè•",
    layout="wide"
)

def load_data():
    dataset_path = "dataset/Disease Symptom Prediction/dataset.csv"
    symptom_desc_path = "dataset/Disease Symptom Prediction/symptom_Description.csv"
    symptom_precaution_path = "dataset/Disease Symptom Prediction/symptom_precaution.csv"
    doctor_disease_path = "dataset/Doctor's Specialty Recommendation/Doctor_Versus_Disease.csv"
    disease_desc_path = "dataset/Doctor's Specialty Recommendation/Disease_Description.csv"
    
    # read CSV file
    df_symptoms = pd.read_csv(dataset_path)
    df_symptom_desc = pd.read_csv(symptom_desc_path)
    df_precaution = pd.read_csv(symptom_precaution_path)
    df_doctor = pd.read_csv(doctor_disease_path)
    df_disease_desc = pd.read_csv(disease_desc_path)
    
    return df_symptoms, df_symptom_desc, df_precaution, df_doctor, df_disease_desc

def prepare_data(df_symptoms):    
    # get all diseases list
    diseases = df_symptoms['Disease'].unique()
    disease_to_idx = {disease: i for i, disease in enumerate(diseases)}
    idx_to_disease = {i: disease for i, disease in enumerate(diseases)}
    
    # get all symptons from dataset
    all_symptoms = set()
    for col in df_symptoms.columns:
        if col.startswith('Symptom_'):
            symptoms = df_symptoms[col].dropna().unique()
            all_symptoms.update(symptoms)
    
    # convert to list and remove NaN value
    all_symptoms = [s for s in all_symptoms if isinstance(s, str)]
    symptom_to_idx = {symptom: i for i, symptom in enumerate(all_symptoms)}
    
    X = []  # list of symptons
    y = []  # disease label

    for _, row in df_symptoms.iterrows():
        disease = row['Disease']
        disease_idx = disease_to_idx[disease]
        
        # get symptons from this disease
        symptoms = []
        for col in df_symptoms.columns:
            if col.startswith('Symptom_') and pd.notna(row[col]):
                symptoms.append(row[col])

        # append to train data
        X.append(symptoms)
        y.append(disease_idx)
    
    return X, y, all_symptoms, symptom_to_idx, disease_to_idx, idx_to_disease

def symptoms_to_input(symptoms, all_symptoms):
    input_vector = [0] * len(all_symptoms)    
    for i, symptom in enumerate(all_symptoms):
        if symptom in symptoms:
            input_vector[i] = 1
    
    return np.array([input_vector])  

# create and train model
def create_and_train_model(X_processed, y, input_size, output_size):
    """T·∫°o v√† hu·∫•n luy·ªán m√¥ h√¨nh neural network ƒë∆°n gi·∫£n"""
    
    # neuron network model
    model = keras.Sequential([
        keras.layers.Dense(128, activation='relu', input_shape=(input_size,)),
        keras.layers.Dense(64, activation='relu'),
        keras.layers.Dense(output_size, activation='softmax')
    ])
    
    # compile model 
    model.compile(
        optimizer='adam',
        loss='sparse_categorical_crossentropy',
        metrics=['accuracy']
    )
    
    # train model
    model.fit(X_processed, y, epochs=20, batch_size=8, verbose=0)
    
    return model

# handle input value 
def process_user_input(user_input, all_symptoms):
    # convert to lower case
    user_input = user_input.lower()
    user_input = re.sub(r'[^\w\s]', ' ', user_input)
    
    # split input value
    words = user_input.split()
    
    # find suitable symptons
    matched_symptoms = []
    
    for symptom in all_symptoms:
        symptom_words = symptom.lower().replace('_', ' ').split()
        
        # check if input value contains symptons
        for symptom_word in symptom_words:
            if any(symptom_word in word or word in symptom_word for word in words):
                matched_symptoms.append(symptom)
                break
    
    return matched_symptoms

# get disease info
def get_disease_info(disease, df_precaution, df_disease_desc, df_doctor):
    """L·∫•y th√¥ng tin v·ªÅ b·ªánh, bi·ªán ph√°p ph√≤ng ng·ª´a v√† b√°c sƒ© chuy√™n khoa"""
    
    # get disease description
    description = ""
    desc_row = df_disease_desc[df_disease_desc['Disease'] == disease]
    if not desc_row.empty and 'Description' in desc_row.columns:
        description = desc_row['Description'].iloc[0]
    
    # get preventive measures
    precautions = []
    precaution_row = df_precaution[df_precaution['Disease'] == disease]
    if not precaution_row.empty:
        for i in range(1, 5):
            col_name = f'Precaution_{i}'
            if col_name in precaution_row.columns:
                precaution = precaution_row[col_name].iloc[0]
                if pd.notna(precaution):
                    precautions.append(precaution)
    
    # get all doctor specialtity
    doctor_specialist = "B√°c sƒ© ƒëa khoa"
    for col in df_doctor.columns:
        if disease in df_doctor[col].values:
            doctor_specialist = col
            break
    
    return description, precautions, doctor_specialist

def main():
    st.title("üè• D·ª± ƒëo√°n b·ªánh t·ª´ tri·ªáu ch·ª©ng")
    st.write("Nh·∫≠p c√°c tri·ªáu ch·ª©ng b·∫°n ƒëang g·∫∑p ph·∫£i ƒë·ªÉ nh·∫≠n d·ª± ƒëo√°n v·ªÅ b·ªánh v√† l·ªùi khuy√™n t·ª´ b√°c sƒ©.")
    st.markdown("---")
    
    # read data
    with st.spinner("ƒêang t·∫£i d·ªØ li·ªáu..."):
        df_symptoms, df_symptom_desc, df_precaution, df_doctor, df_disease_desc = load_data()
    
    with st.spinner("ƒêang chu·∫©n b·ªã d·ªØ li·ªáu..."):
        X, y, all_symptoms, symptom_to_idx, disease_to_idx, idx_to_disease = prepare_data(df_symptoms)
        
        # to data to train
        X_processed = []
        for symptoms in X:
            X_processed.append([1 if s in symptoms else 0 for s in all_symptoms])
        X_processed = np.array(X_processed)
    
    # train model
    with st.spinner("ƒêang hu·∫•n luy·ªán m√¥ h√¨nh..."):
        model = create_and_train_model(X_processed, y, len(all_symptoms), len(disease_to_idx))
    
    st.success("‚úÖ M√¥ h√¨nh ƒë√£ s·∫µn s√†ng!")
    
    # sidebar
    with st.sidebar:
        st.header("üìã Th√¥ng tin")
        st.write(f"S·ªë l∆∞·ª£ng tri·ªáu ch·ª©ng: {len(all_symptoms)}")
        st.write(f"S·ªë lo·∫°i b·ªánh: {len(disease_to_idx)}")
        
        st.header("üí° H∆∞·ªõng d·∫´n")
        st.write("1. Nh·∫≠p c√°c tri·ªáu ch·ª©ng v√†o √¥ b√™n d∆∞·ªõi")
        st.write("2. Nh·∫•n n√∫t 'D·ª± ƒëo√°n b·ªánh'")
        st.write("3. Xem k·∫øt qu·∫£ v√† l·ªùi khuy√™n")
        
        st.header("‚ö†Ô∏è L∆∞u √Ω")
        st.warning("ƒê√¢y ch·ªâ l√† c√¥ng c·ª• h·ªó tr·ª£, kh√¥ng thay th·∫ø cho vi·ªác kh√°m b√°c sƒ©!")
    
    
    st.header("üí¨ Nh·∫≠p tri·ªáu ch·ª©ng c·ªßa b·∫°n")
    
    # show some examples
    with st.expander("üîç Xem v√≠ d·ª• tri·ªáu ch·ª©ng"):
        st.write("‚Ä¢ s·ªët cao, ho, ƒëau ƒë·∫ßu, m·ªát m·ªèi")
        st.write("‚Ä¢ ƒëau b·ª•ng, bu·ªìn n√¥n, ti√™u ch·∫£y")
        st.write("‚Ä¢ kh√≥ th·ªü, ƒëau ng·ª±c, tim ƒë·∫≠p nhanh")
        st.write("‚Ä¢ ƒëau kh·ªõp, s∆∞ng kh·ªõp, c·ª©ng kh·ªõp")
    
    # symptons input
    user_input = st.text_area(
        "M√¥ t·∫£ c√°c tri·ªáu ch·ª©ng b·∫°n ƒëang g·∫∑p ph·∫£i:",
        placeholder="V√≠ d·ª•: s·ªët cao, ho khan, ƒëau ƒë·∫ßu...",
        height=100
    )
    
    # predict button
    predict_button = st.button("üîç D·ª± ƒëo√°n b·ªánh", type="primary")
    
    # predict button handle
    if predict_button and user_input.strip():
        with st.spinner("ƒêang ph√¢n t√≠ch tri·ªáu ch·ª©ng..."):
            # user's input handle
            matched_symptoms = process_user_input(user_input, all_symptoms)
            
            if not matched_symptoms:
                st.warning("‚ö†Ô∏è Kh√¥ng nh·∫≠n di·ªán ƒë∆∞·ª£c tri·ªáu ch·ª©ng n√†o. Vui l√≤ng th·ª≠ l·∫°i v·ªõi m√¥ t·∫£ chi ti·∫øt h∆°n.")
            else:
                # sympton recognize
                st.success(f"‚úÖ ƒê√£ nh·∫≠n di·ªán {len(matched_symptoms)} tri·ªáu ch·ª©ng:")
                
                # sympton recognize
                symptom_display = [s.replace('_', ' ').title() for s in matched_symptoms]
                st.write(", ".join(symptom_display))
                
                # input -> model
                input_vector = symptoms_to_input(matched_symptoms, all_symptoms)
                
                # predict disease
                prediction = model.predict(input_vector, verbose=0)
                predicted_idx = np.argmax(prediction[0])
                confidence = prediction[0][predicted_idx]
                
                # get disease name from index
                predicted_disease = idx_to_disease[predicted_idx]
                
                # show result prediction
                st.markdown("---")
                st.header("üéØ K·∫øt qu·∫£ d·ª± ƒëo√°n")
                
                col1, col2 = st.columns(2)
                with col1:
                    st.metric("B·ªánh d·ª± ƒëo√°n", predicted_disease)
                with col2:
                    st.metric("ƒê·ªô tin c·∫≠y", f"{confidence:.1%}")
                
                # get disease info
                description, precautions, doctor_specialist = get_disease_info(
                    predicted_disease, df_precaution, df_disease_desc, df_doctor
                )
                
                # disease info
                st.markdown("---")
                st.header("üìñ Th√¥ng tin v·ªÅ b·ªánh")
                
                if description:
                    st.write(description)
                else:
                    st.write("Kh√¥ng c√≥ th√¥ng tin chi ti·∫øt v·ªÅ b·ªánh n√†y.")
                
                # recommend method
                if precautions:
                    st.markdown("---")
                    st.header("üõ°Ô∏è Bi·ªán ph√°p ph√≤ng ng·ª´a")
                    
                    for i, precaution in enumerate(precautions, 1):
                        st.write(f"{i}. {precaution.replace('_', ' ').title()}")
                
                # doctor speciality recommend
                st.markdown("---")
                st.header("üë®‚Äç‚öïÔ∏è B√°c sƒ© chuy√™n khoa")
                st.info(f"B·∫°n n√™n ƒë·∫øn kh√°m: **{doctor_specialist.replace('_', ' ').title()}**")
                
                # Attention note
                st.markdown("---")
                st.warning("‚ö†Ô∏è **L∆∞u √Ω quan tr·ªçng:** K·∫øt qu·∫£ n√†y ch·ªâ mang t√≠nh ch·∫•t tham kh·∫£o. Vui l√≤ng tham kh·∫£o √Ω ki·∫øn b√°c sƒ© ƒë·ªÉ c√≥ ch·∫©n ƒëo√°n ch√≠nh x√°c.")
    
    elif predict_button:
        st.warning("‚ö†Ô∏è Vui l√≤ng nh·∫≠p tri·ªáu ch·ª©ng tr∆∞·ªõc khi d·ª± ƒëo√°n!")
    
    # Footer
    st.markdown("---")
    st.markdown(
        """
        <div style='text-align: center; color: gray;'>
        <p>üè• H·ªá th·ªëng D·ª± ƒëo√°n B·ªánh | ƒê∆∞·ª£c ph√°t tri·ªÉn b·∫±ng TensorFlow & Streamlit</p>
        </div>
        """, 
        unsafe_allow_html=True
    )

if __name__ == "__main__":
    main()
